import assert from "node:assert/strict";
import { NetworkMeasurer } from "./measurements/network.js";
import { TimingMeasurer } from "./measurements/timing.js";
import { MeasurementType } from "./types.js";
const measurerTypeToClassMap = {
    [MeasurementType.Network]: NetworkMeasurer,
    [MeasurementType.Timing]: TimingMeasurer,
};
export const measureURL = async (logger, context, url, seconds, timeout, measurements) => {
    // Create and instantiate any measurement classes that were requested
    const measurers = new Map();
    for (const aMeasurementType of measurements) {
        const aMeasurerType = measurerTypeToClassMap[aMeasurementType];
        const aMeasurer = new aMeasurerType(logger, url, context);
        measurers.set(aMeasurementType, aMeasurer);
    }
    const page = await context.newPage();
    const startTime = new Date();
    logger.info(`Navigating to url="${page.url()}"`);
    const navRequest = await page.goto(url.toString(), {
        timeout: timeout * 1000,
        waitUntil: "commit",
    });
    assert(navRequest);
    logger.info(`Arrived at url="${page.url()}"`);
    const netMeasurer = measurers.get(MeasurementType.Network);
    if (netMeasurer) {
        await netMeasurer.addInitNavigationResponse(page, navRequest);
    }
    logger.info(`Letting page load for "${String(seconds)}" seconds`);
    await page.waitForTimeout(seconds * 1000);
    for (const aMeasurer of measurers.values()) {
        aMeasurer.close();
    }
    await page.waitForTimeout(5 * 1000);
    const results = {};
    for (const [aMeasurementType, aMeasurer] of measurers.entries()) {
        results[aMeasurementType] = await aMeasurer.collect();
    }
    await context.close();
    return {
        end: new Date(),
        measurements: results,
        start: startTime,
        url: url,
    };
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWVhc3VyZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9tZWFzdXJlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sTUFBTSxNQUFNLG9CQUFvQixDQUFDO0FBTXhDLE9BQU8sRUFBRSxlQUFlLEVBQUUsTUFBTSwyQkFBMkIsQ0FBQztBQUM1RCxPQUFPLEVBQUUsY0FBYyxFQUFFLE1BQU0sMEJBQTBCLENBQUM7QUFDMUQsT0FBTyxFQUFFLGVBQWUsRUFBVSxNQUFNLFlBQVksQ0FBQztBQUVyRCxNQUFNLHNCQUFzQixHQUFpRDtJQUMzRSxDQUFDLGVBQWUsQ0FBQyxPQUFPLENBQUMsRUFBRSxlQUFlO0lBQzFDLENBQUMsZUFBZSxDQUFDLE1BQU0sQ0FBQyxFQUFFLGNBQWM7Q0FDekMsQ0FBQztBQUVGLE1BQU0sQ0FBQyxNQUFNLFVBQVUsR0FBRyxLQUFLLEVBQzdCLE1BQWMsRUFDZCxPQUF1QixFQUN2QixHQUFRLEVBQ1IsT0FBZSxFQUNmLE9BQWUsRUFDZixZQUErQixFQUNkLEVBQUU7SUFDbkIscUVBQXFFO0lBQ3JFLE1BQU0sU0FBUyxHQUFHLElBQUksR0FBRyxFQUFpQyxDQUFDO0lBQzNELEtBQUssTUFBTSxnQkFBZ0IsSUFBSSxZQUFZLEVBQUUsQ0FBQztRQUM1QyxNQUFNLGFBQWEsR0FBRyxzQkFBc0IsQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDO1FBQy9ELE1BQU0sU0FBUyxHQUFHLElBQUksYUFBYSxDQUFDLE1BQU0sRUFBRSxHQUFHLEVBQUUsT0FBTyxDQUFDLENBQUM7UUFDMUQsU0FBUyxDQUFDLEdBQUcsQ0FBQyxnQkFBZ0IsRUFBRSxTQUFTLENBQUMsQ0FBQztJQUM3QyxDQUFDO0lBRUQsTUFBTSxJQUFJLEdBQUcsTUFBTSxPQUFPLENBQUMsT0FBTyxFQUFFLENBQUM7SUFDckMsTUFBTSxTQUFTLEdBQUcsSUFBSSxJQUFJLEVBQUUsQ0FBQztJQUM3QixNQUFNLENBQUMsSUFBSSxDQUFDLHNCQUFzQixJQUFJLENBQUMsR0FBRyxFQUFFLEdBQUcsQ0FBQyxDQUFDO0lBQ2pELE1BQU0sVUFBVSxHQUFHLE1BQU0sSUFBSSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsUUFBUSxFQUFFLEVBQUU7UUFDakQsT0FBTyxFQUFFLE9BQU8sR0FBRyxJQUFJO1FBQ3ZCLFNBQVMsRUFBRSxRQUFRO0tBQ3BCLENBQUMsQ0FBQztJQUNILE1BQU0sQ0FBQyxVQUFVLENBQUMsQ0FBQztJQUVuQixNQUFNLENBQUMsSUFBSSxDQUFDLG1CQUFtQixJQUFJLENBQUMsR0FBRyxFQUFFLEdBQUcsQ0FBQyxDQUFDO0lBQzlDLE1BQU0sV0FBVyxHQUFHLFNBQVMsQ0FBQyxHQUFHLENBQUMsZUFBZSxDQUFDLE9BQU8sQ0FBQyxDQUFDO0lBQzNELElBQUksV0FBVyxFQUFFLENBQUM7UUFDaEIsTUFBTyxXQUErQixDQUFDLHlCQUF5QixDQUM5RCxJQUFJLEVBQ0osVUFBVSxDQUNYLENBQUM7SUFDSixDQUFDO0lBRUQsTUFBTSxDQUFDLElBQUksQ0FBQywwQkFBMEIsTUFBTSxDQUFDLE9BQU8sQ0FBQyxXQUFXLENBQUMsQ0FBQztJQUNsRSxNQUFNLElBQUksQ0FBQyxjQUFjLENBQUMsT0FBTyxHQUFHLElBQUksQ0FBQyxDQUFDO0lBRTFDLEtBQUssTUFBTSxTQUFTLElBQUksU0FBUyxDQUFDLE1BQU0sRUFBRSxFQUFFLENBQUM7UUFDM0MsU0FBUyxDQUFDLEtBQUssRUFBRSxDQUFDO0lBQ3BCLENBQUM7SUFDRCxNQUFNLElBQUksQ0FBQyxjQUFjLENBQUMsQ0FBQyxHQUFHLElBQUksQ0FBQyxDQUFDO0lBRXBDLE1BQU0sT0FBTyxHQUFHLEVBQXVELENBQUM7SUFDeEUsS0FBSyxNQUFNLENBQUMsZ0JBQWdCLEVBQUUsU0FBUyxDQUFDLElBQUksU0FBUyxDQUFDLE9BQU8sRUFBRSxFQUFFLENBQUM7UUFDaEUsT0FBTyxDQUFDLGdCQUFnQixDQUFDLEdBQUcsTUFBTSxTQUFTLENBQUMsT0FBTyxFQUFFLENBQUM7SUFDeEQsQ0FBQztJQUVELE1BQU0sT0FBTyxDQUFDLEtBQUssRUFBRSxDQUFDO0lBQ3RCLE9BQU87UUFDTCxHQUFHLEVBQUUsSUFBSSxJQUFJLEVBQUU7UUFDZixZQUFZLEVBQUUsT0FBTztRQUNyQixLQUFLLEVBQUUsU0FBUztRQUNoQixHQUFHLEVBQUUsR0FBRztLQUNULENBQUM7QUFDSixDQUFDLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgYXNzZXJ0IGZyb20gXCJub2RlOmFzc2VydC9zdHJpY3RcIjtcblxuaW1wb3J0IHsgQnJvd3NlckNvbnRleHQgfSBmcm9tIFwiQHBsYXl3cmlnaHQvdGVzdFwiO1xuXG5pbXBvcnQgeyBMb2dnZXIgfSBmcm9tIFwiLi9sb2dnaW5nLmpzXCI7XG5pbXBvcnQgeyBCYXNlTWVhc3VyZXIsIE1lYXN1cmVtZW50UmVzdWx0IH0gZnJvbSBcIi4vbWVhc3VyZW1lbnRzL2Jhc2UuanNcIjtcbmltcG9ydCB7IE5ldHdvcmtNZWFzdXJlciB9IGZyb20gXCIuL21lYXN1cmVtZW50cy9uZXR3b3JrLmpzXCI7XG5pbXBvcnQgeyBUaW1pbmdNZWFzdXJlciB9IGZyb20gXCIuL21lYXN1cmVtZW50cy90aW1pbmcuanNcIjtcbmltcG9ydCB7IE1lYXN1cmVtZW50VHlwZSwgUmVwb3J0IH0gZnJvbSBcIi4vdHlwZXMuanNcIjtcblxuY29uc3QgbWVhc3VyZXJUeXBlVG9DbGFzc01hcDogUmVjb3JkPE1lYXN1cmVtZW50VHlwZSwgdHlwZW9mIEJhc2VNZWFzdXJlcj4gPSB7XG4gIFtNZWFzdXJlbWVudFR5cGUuTmV0d29ya106IE5ldHdvcmtNZWFzdXJlcixcbiAgW01lYXN1cmVtZW50VHlwZS5UaW1pbmddOiBUaW1pbmdNZWFzdXJlcixcbn07XG5cbmV4cG9ydCBjb25zdCBtZWFzdXJlVVJMID0gYXN5bmMgKFxuICBsb2dnZXI6IExvZ2dlcixcbiAgY29udGV4dDogQnJvd3NlckNvbnRleHQsXG4gIHVybDogVVJMLFxuICBzZWNvbmRzOiBudW1iZXIsXG4gIHRpbWVvdXQ6IG51bWJlcixcbiAgbWVhc3VyZW1lbnRzOiBNZWFzdXJlbWVudFR5cGVbXSxcbik6IFByb21pc2U8UmVwb3J0PiA9PiB7XG4gIC8vIENyZWF0ZSBhbmQgaW5zdGFudGlhdGUgYW55IG1lYXN1cmVtZW50IGNsYXNzZXMgdGhhdCB3ZXJlIHJlcXVlc3RlZFxuICBjb25zdCBtZWFzdXJlcnMgPSBuZXcgTWFwPE1lYXN1cmVtZW50VHlwZSwgQmFzZU1lYXN1cmVyPigpO1xuICBmb3IgKGNvbnN0IGFNZWFzdXJlbWVudFR5cGUgb2YgbWVhc3VyZW1lbnRzKSB7XG4gICAgY29uc3QgYU1lYXN1cmVyVHlwZSA9IG1lYXN1cmVyVHlwZVRvQ2xhc3NNYXBbYU1lYXN1cmVtZW50VHlwZV07XG4gICAgY29uc3QgYU1lYXN1cmVyID0gbmV3IGFNZWFzdXJlclR5cGUobG9nZ2VyLCB1cmwsIGNvbnRleHQpO1xuICAgIG1lYXN1cmVycy5zZXQoYU1lYXN1cmVtZW50VHlwZSwgYU1lYXN1cmVyKTtcbiAgfVxuXG4gIGNvbnN0IHBhZ2UgPSBhd2FpdCBjb250ZXh0Lm5ld1BhZ2UoKTtcbiAgY29uc3Qgc3RhcnRUaW1lID0gbmV3IERhdGUoKTtcbiAgbG9nZ2VyLmluZm8oYE5hdmlnYXRpbmcgdG8gdXJsPVwiJHtwYWdlLnVybCgpfVwiYCk7XG4gIGNvbnN0IG5hdlJlcXVlc3QgPSBhd2FpdCBwYWdlLmdvdG8odXJsLnRvU3RyaW5nKCksIHtcbiAgICB0aW1lb3V0OiB0aW1lb3V0ICogMTAwMCxcbiAgICB3YWl0VW50aWw6IFwiY29tbWl0XCIsXG4gIH0pO1xuICBhc3NlcnQobmF2UmVxdWVzdCk7XG5cbiAgbG9nZ2VyLmluZm8oYEFycml2ZWQgYXQgdXJsPVwiJHtwYWdlLnVybCgpfVwiYCk7XG4gIGNvbnN0IG5ldE1lYXN1cmVyID0gbWVhc3VyZXJzLmdldChNZWFzdXJlbWVudFR5cGUuTmV0d29yayk7XG4gIGlmIChuZXRNZWFzdXJlcikge1xuICAgIGF3YWl0IChuZXRNZWFzdXJlciBhcyBOZXR3b3JrTWVhc3VyZXIpLmFkZEluaXROYXZpZ2F0aW9uUmVzcG9uc2UoXG4gICAgICBwYWdlLFxuICAgICAgbmF2UmVxdWVzdCxcbiAgICApO1xuICB9XG5cbiAgbG9nZ2VyLmluZm8oYExldHRpbmcgcGFnZSBsb2FkIGZvciBcIiR7U3RyaW5nKHNlY29uZHMpfVwiIHNlY29uZHNgKTtcbiAgYXdhaXQgcGFnZS53YWl0Rm9yVGltZW91dChzZWNvbmRzICogMTAwMCk7XG5cbiAgZm9yIChjb25zdCBhTWVhc3VyZXIgb2YgbWVhc3VyZXJzLnZhbHVlcygpKSB7XG4gICAgYU1lYXN1cmVyLmNsb3NlKCk7XG4gIH1cbiAgYXdhaXQgcGFnZS53YWl0Rm9yVGltZW91dCg1ICogMTAwMCk7XG5cbiAgY29uc3QgcmVzdWx0cyA9IHt9IGFzIFJlY29yZDxNZWFzdXJlbWVudFR5cGUsIE1lYXN1cmVtZW50UmVzdWx0IHwgbnVsbD47XG4gIGZvciAoY29uc3QgW2FNZWFzdXJlbWVudFR5cGUsIGFNZWFzdXJlcl0gb2YgbWVhc3VyZXJzLmVudHJpZXMoKSkge1xuICAgIHJlc3VsdHNbYU1lYXN1cmVtZW50VHlwZV0gPSBhd2FpdCBhTWVhc3VyZXIuY29sbGVjdCgpO1xuICB9XG5cbiAgYXdhaXQgY29udGV4dC5jbG9zZSgpO1xuICByZXR1cm4ge1xuICAgIGVuZDogbmV3IERhdGUoKSxcbiAgICBtZWFzdXJlbWVudHM6IHJlc3VsdHMsXG4gICAgc3RhcnQ6IHN0YXJ0VGltZSxcbiAgICB1cmw6IHVybCxcbiAgfTtcbn07XG4iXX0=