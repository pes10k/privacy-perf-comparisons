import { BaseMeasurer } from "./base.js";
import { MeasurementType } from "../types.js";
const injected_getPageMeasurements = () => {
    return new Promise((resolve) => {
        const navEntries = window.performance.getEntriesByType("navigation")[0];
        const observer = new PerformanceObserver((list) => {
            const entries = list.getEntries();
            const lastLCPEntry = entries[entries.length - 1];
            resolve({
                navigation: navEntries.toJSON(),
                lcp: lastLCPEntry.toJSON(),
            });
        });
        observer.observe({
            type: "largest-contentful-paint",
            buffered: true,
        });
    });
};
export class TimingMeasurer extends BaseMeasurer {
    measurementType() {
        return MeasurementType.Timing;
    }
    async collect() {
        if (this.isContextClosed) {
            this.logInfo("Tried to collect results from a closed browser context");
            return null;
        }
        const timingMeasurements = [];
        for (const aPage of this.context.pages()) {
            const pageURL = aPage.url();
            if (!pageURL.startsWith("http")) {
                this.logVerbose("Not fetching timing for non-public URL: ", pageURL);
                continue;
            }
            this.logInfo("fetching timing information for page url=", pageURL);
            const pageResponse = await aPage.evaluate(injected_getPageMeasurements);
            const timingData = {
                url: pageURL,
                data: pageResponse,
            };
            timingMeasurements.push(timingData);
        }
        return {
            type: this.measurementType(),
            data: timingMeasurements,
        };
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGltaW5nLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL21lYXN1cmVtZW50cy90aW1pbmcudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFlBQVksRUFBcUIsTUFBTSxXQUFXLENBQUM7QUFDNUQsT0FBTyxFQUFFLGVBQWUsRUFBZ0IsTUFBTSxhQUFhLENBQUM7QUFFNUQsTUFBTSw0QkFBNEIsR0FBRyxHQUEwQixFQUFFO0lBQy9ELE9BQU8sSUFBSSxPQUFPLENBQUMsQ0FBQyxPQUFPLEVBQUUsRUFBRTtRQUM3QixNQUFNLFVBQVUsR0FBRyxNQUFNLENBQUMsV0FBVyxDQUFDLGdCQUFnQixDQUFDLFlBQVksQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBRXhFLE1BQU0sUUFBUSxHQUFHLElBQUksbUJBQW1CLENBQUMsQ0FBQyxJQUFJLEVBQUUsRUFBRTtZQUNoRCxNQUFNLE9BQU8sR0FBRyxJQUFJLENBQUMsVUFBVSxFQUFFLENBQUM7WUFDbEMsTUFBTSxZQUFZLEdBQUcsT0FBTyxDQUFDLE9BQU8sQ0FBQyxNQUFNLEdBQUcsQ0FBQyxDQUFDLENBQUM7WUFDakQsT0FBTyxDQUFDO2dCQUNOLFVBQVUsRUFBRSxVQUFVLENBQUMsTUFBTSxFQUFhO2dCQUMxQyxHQUFHLEVBQUUsWUFBWSxDQUFDLE1BQU0sRUFBYTthQUN0QyxDQUFDLENBQUM7UUFDTCxDQUFDLENBQUMsQ0FBQztRQUVILFFBQVEsQ0FBQyxPQUFPLENBQUM7WUFDZixJQUFJLEVBQUUsMEJBQTBCO1lBQ2hDLFFBQVEsRUFBRSxJQUFJO1NBQ2YsQ0FBQyxDQUFDO0lBQ0wsQ0FBQyxDQUFDLENBQUM7QUFDTCxDQUFDLENBQUM7QUFFRixNQUFNLE9BQU8sY0FBZSxTQUFRLFlBQVk7SUFDOUMsZUFBZTtRQUNiLE9BQU8sZUFBZSxDQUFDLE1BQU0sQ0FBQztJQUNoQyxDQUFDO0lBRUQsS0FBSyxDQUFDLE9BQU87UUFDWCxJQUFJLElBQUksQ0FBQyxlQUFlLEVBQUUsQ0FBQztZQUN6QixJQUFJLENBQUMsT0FBTyxDQUFDLHdEQUF3RCxDQUFDLENBQUM7WUFDdkUsT0FBTyxJQUFJLENBQUM7UUFDZCxDQUFDO1FBRUQsTUFBTSxrQkFBa0IsR0FBRyxFQUFFLENBQUM7UUFDOUIsS0FBSyxNQUFNLEtBQUssSUFBSSxJQUFJLENBQUMsT0FBTyxDQUFDLEtBQUssRUFBRSxFQUFFLENBQUM7WUFDekMsTUFBTSxPQUFPLEdBQUcsS0FBSyxDQUFDLEdBQUcsRUFBRSxDQUFDO1lBQzVCLElBQUksQ0FBQyxPQUFPLENBQUMsVUFBVSxDQUFDLE1BQU0sQ0FBQyxFQUFFLENBQUM7Z0JBQ2hDLElBQUksQ0FBQyxVQUFVLENBQUMsMENBQTBDLEVBQUUsT0FBTyxDQUFDLENBQUM7Z0JBQ3JFLFNBQVM7WUFDWCxDQUFDO1lBRUQsSUFBSSxDQUFDLE9BQU8sQ0FBQywyQ0FBMkMsRUFBRSxPQUFPLENBQUMsQ0FBQztZQUNuRSxNQUFNLFlBQVksR0FBRyxNQUFNLEtBQUssQ0FBQyxRQUFRLENBQUMsNEJBQTRCLENBQUMsQ0FBQztZQUN4RSxNQUFNLFVBQVUsR0FBRztnQkFDakIsR0FBRyxFQUFFLE9BQU87Z0JBQ1osSUFBSSxFQUFFLFlBQVk7YUFDbkIsQ0FBQztZQUNGLGtCQUFrQixDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsQ0FBQztRQUN0QyxDQUFDO1FBRUQsT0FBTztZQUNMLElBQUksRUFBRSxJQUFJLENBQUMsZUFBZSxFQUFFO1lBQzVCLElBQUksRUFBRSxrQkFBa0I7U0FDekIsQ0FBQztJQUNKLENBQUM7Q0FDRiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEJhc2VNZWFzdXJlciwgTWVhc3VyZW1lbnRSZXN1bHQgfSBmcm9tIFwiLi9iYXNlLmpzXCI7XG5pbXBvcnQgeyBNZWFzdXJlbWVudFR5cGUsIFNlcmlhbGl6YWJsZSB9IGZyb20gXCIuLi90eXBlcy5qc1wiO1xuXG5jb25zdCBpbmplY3RlZF9nZXRQYWdlTWVhc3VyZW1lbnRzID0gKCk6IFByb21pc2U8U2VyaWFsaXphYmxlPiA9PiB7XG4gIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSkgPT4ge1xuICAgIGNvbnN0IG5hdkVudHJpZXMgPSB3aW5kb3cucGVyZm9ybWFuY2UuZ2V0RW50cmllc0J5VHlwZShcIm5hdmlnYXRpb25cIilbMF07XG5cbiAgICBjb25zdCBvYnNlcnZlciA9IG5ldyBQZXJmb3JtYW5jZU9ic2VydmVyKChsaXN0KSA9PiB7XG4gICAgICBjb25zdCBlbnRyaWVzID0gbGlzdC5nZXRFbnRyaWVzKCk7XG4gICAgICBjb25zdCBsYXN0TENQRW50cnkgPSBlbnRyaWVzW2VudHJpZXMubGVuZ3RoIC0gMV07XG4gICAgICByZXNvbHZlKHtcbiAgICAgICAgbmF2aWdhdGlvbjogbmF2RW50cmllcy50b0pTT04oKSBhcyB1bmtub3duLFxuICAgICAgICBsY3A6IGxhc3RMQ1BFbnRyeS50b0pTT04oKSBhcyB1bmtub3duLFxuICAgICAgfSk7XG4gICAgfSk7XG5cbiAgICBvYnNlcnZlci5vYnNlcnZlKHtcbiAgICAgIHR5cGU6IFwibGFyZ2VzdC1jb250ZW50ZnVsLXBhaW50XCIsXG4gICAgICBidWZmZXJlZDogdHJ1ZSxcbiAgICB9KTtcbiAgfSk7XG59O1xuXG5leHBvcnQgY2xhc3MgVGltaW5nTWVhc3VyZXIgZXh0ZW5kcyBCYXNlTWVhc3VyZXIge1xuICBtZWFzdXJlbWVudFR5cGUoKTogTWVhc3VyZW1lbnRUeXBlIHtcbiAgICByZXR1cm4gTWVhc3VyZW1lbnRUeXBlLlRpbWluZztcbiAgfVxuXG4gIGFzeW5jIGNvbGxlY3QoKTogUHJvbWlzZTxNZWFzdXJlbWVudFJlc3VsdCB8IG51bGw+IHtcbiAgICBpZiAodGhpcy5pc0NvbnRleHRDbG9zZWQpIHtcbiAgICAgIHRoaXMubG9nSW5mbyhcIlRyaWVkIHRvIGNvbGxlY3QgcmVzdWx0cyBmcm9tIGEgY2xvc2VkIGJyb3dzZXIgY29udGV4dFwiKTtcbiAgICAgIHJldHVybiBudWxsO1xuICAgIH1cblxuICAgIGNvbnN0IHRpbWluZ01lYXN1cmVtZW50cyA9IFtdO1xuICAgIGZvciAoY29uc3QgYVBhZ2Ugb2YgdGhpcy5jb250ZXh0LnBhZ2VzKCkpIHtcbiAgICAgIGNvbnN0IHBhZ2VVUkwgPSBhUGFnZS51cmwoKTtcbiAgICAgIGlmICghcGFnZVVSTC5zdGFydHNXaXRoKFwiaHR0cFwiKSkge1xuICAgICAgICB0aGlzLmxvZ1ZlcmJvc2UoXCJOb3QgZmV0Y2hpbmcgdGltaW5nIGZvciBub24tcHVibGljIFVSTDogXCIsIHBhZ2VVUkwpO1xuICAgICAgICBjb250aW51ZTtcbiAgICAgIH1cblxuICAgICAgdGhpcy5sb2dJbmZvKFwiZmV0Y2hpbmcgdGltaW5nIGluZm9ybWF0aW9uIGZvciBwYWdlIHVybD1cIiwgcGFnZVVSTCk7XG4gICAgICBjb25zdCBwYWdlUmVzcG9uc2UgPSBhd2FpdCBhUGFnZS5ldmFsdWF0ZShpbmplY3RlZF9nZXRQYWdlTWVhc3VyZW1lbnRzKTtcbiAgICAgIGNvbnN0IHRpbWluZ0RhdGEgPSB7XG4gICAgICAgIHVybDogcGFnZVVSTCxcbiAgICAgICAgZGF0YTogcGFnZVJlc3BvbnNlLFxuICAgICAgfTtcbiAgICAgIHRpbWluZ01lYXN1cmVtZW50cy5wdXNoKHRpbWluZ0RhdGEpO1xuICAgIH1cblxuICAgIHJldHVybiB7XG4gICAgICB0eXBlOiB0aGlzLm1lYXN1cmVtZW50VHlwZSgpLFxuICAgICAgZGF0YTogdGltaW5nTWVhc3VyZW1lbnRzLFxuICAgIH07XG4gIH1cbn1cbiJdfQ==