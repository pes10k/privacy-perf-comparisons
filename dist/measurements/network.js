import assert from "node:assert/strict";
import { BaseMeasurer } from "./base.js";
import { MeasurementType } from "../types.js";
class PageNetworkLogger {
    #owner;
    #requests = [];
    #responses = [];
    #pageURL;
    #logger;
    #startTime;
    constructor(owner, logger, pageURL) {
        this.#owner = owner;
        this.#pageURL = pageURL;
        this.#logger = logger;
        this.#startTime = Date.now();
    }
    toJSON() {
        return {
            meta: {
                startTime: this.#startTime,
                url: this.#pageURL,
            },
            requests: this.#requests,
            responses: this.#responses,
        };
    }
    isClosed() {
        return this.#owner.isClosed();
    }
    logErrorIfClosed(msg, url) {
        if (this.isClosed()) {
            this.#logger.error(`tried to record "${msg}" but measurements are ` +
                `closed. url=$"${url}"`);
            return true;
        }
        return false;
    }
    addWebSocketRequest(url, data) {
        if (this.logErrorIfClosed("ws request", url)) {
            return null;
        }
        const datapoint = {
            size: data.length,
            time: Date.now(),
            type: "websocket",
            url: url,
        };
        this.#requests.push(datapoint);
        this.#logger.verbose("Network (Sent) : ", datapoint);
        return datapoint;
    }
    addWebSocketResponse(url, data) {
        if (this.logErrorIfClosed("ws response", url)) {
            return null;
        }
        const datapoint = {
            size: data.length,
            time: Date.now(),
            type: "websocket",
            url: url,
        };
        this.#responses.push(datapoint);
        this.#logger.verbose("Network (Received) : ", datapoint);
        return datapoint;
    }
    async addRequest(request) {
        if (this.logErrorIfClosed("request", request.url())) {
            return null;
        }
        const sizes = await request.sizes();
        const datapoint = {
            size: sizes.requestHeadersSize + sizes.requestBodySize,
            time: request.timing().requestStart,
            type: request.resourceType(),
            url: request.url(),
        };
        this.#requests.push(datapoint);
        this.#logger.verbose("Network (Sent) : ", datapoint);
        return datapoint;
    }
    async addResponse(response) {
        if (this.logErrorIfClosed("response", response.url())) {
            return null;
        }
        let request = response.request();
        const sizes = await request.sizes();
        const datapoint = {
            size: sizes.responseHeadersSize + sizes.responseBodySize,
            time: request.timing().responseEnd,
            type: request.resourceType(),
            url: response.url(),
        };
        this.#responses.push(datapoint);
        this.#logger.verbose("Network (Received) : ", datapoint);
        // And now see if this response was a result of a redirection chain,
        // in which case we need to add all the intermediate requests too
        // (since we'll have already recorded the initial request).
        while (request.redirectedFrom()) {
            await this.addRequest(request);
            const nextRequest = request.redirectedFrom();
            assert(nextRequest);
            request = nextRequest;
        }
        return datapoint;
    }
}
class ContextNetworkLogger {
    #pageLoggers = [];
    #pageToLoggerMap;
    #logger;
    #startTime;
    #isClosed = false;
    #endTime;
    constructor(logger) {
        this.#startTime = Date.now();
        this.#pageToLoggerMap = new WeakMap();
        this.#logger = logger;
    }
    // Used to record the request for thats driving a page navigation (i.e.,
    // the initial request to start automation, caused by something like
    // a puppeteer / playwright page.goto() call).
    async addAutomationPageNavigation(page, response) {
        if (this.isClosed()) {
            this.#logger.error("trying to record top frame navigation, " +
                "but measurements have been closed. " +
                `page url="${page.url()}"`);
            return null;
        }
        const pageMeasurements = this.#pageToLoggerMap.get(page);
        if (!pageMeasurements) {
            const errMsg = "Page navigation for an unknown page. " + `page url="${page.url()}"`;
            this.#logger.error(errMsg);
            return null;
        }
        const navRequest = response.request();
        await pageMeasurements.addRequest(navRequest);
        await pageMeasurements.addResponse(response);
    }
    addWSRequest(page, url, data) {
        const pageForRequest = this.#pageToLoggerMap.get(page);
        assert(pageForRequest);
        return pageForRequest.addWebSocketRequest(url, data);
    }
    addWSResponse(page, url, data) {
        const pageForResponse = this.#pageToLoggerMap.get(page);
        assert(pageForResponse);
        return pageForResponse.addWebSocketResponse(url, data);
    }
    async addRequest(page, request) {
        const pageForRequest = this.#pageToLoggerMap.get(page);
        assert(pageForRequest);
        return await pageForRequest.addRequest(request);
    }
    async addResponse(page, response) {
        const pageForResponse = this.#pageToLoggerMap.get(page);
        assert(pageForResponse);
        return await pageForResponse.addResponse(response);
    }
    // Notes that the top level frame in the page has navigated, and so
    // any future requests that happen on the page are happening on a different
    // top level document.
    notePageNavigation(page) {
        if (this.isClosed()) {
            this.#logger.error("trying to add measurements for new top frame " +
                "but measurements have been closed. " +
                `page url="${page.url()}"`);
            return null;
        }
        const pageLogger = new PageNetworkLogger(this, this.#logger, page.url());
        this.#pageLoggers.push(pageLogger);
        this.#pageToLoggerMap.set(page, pageLogger);
        return pageLogger;
    }
    isClosed() {
        return this.#isClosed;
    }
    toJSON() {
        const pageReports = [];
        for (const aLogger of this.#pageLoggers) {
            pageReports.push(aLogger.toJSON());
        }
        return {
            meta: {
                startTime: this.#startTime,
                endTime: this.#endTime,
            },
            pages: pageReports,
        };
    }
    close() {
        if (this.isClosed()) {
            this.#logger.error("trying to close already closed network measurements");
            return false;
        }
        this.#endTime = Date.now();
        this.#isClosed = true;
        this.#logger.verbose("closing network measurements");
        return true;
    }
}
export class NetworkMeasurer extends BaseMeasurer {
    #netLogger;
    constructor(logger, url, context) {
        super(logger, url, context);
        this.#netLogger = new ContextNetworkLogger(logger);
    }
    measurementType() {
        return MeasurementType.Network;
    }
    instrument() {
        super.instrument();
        this.context.on("page", (page) => {
            page.on("websocket", (webSocket) => {
                const wsUrl = webSocket.url();
                webSocket.on("framesent", (data) => {
                    this.#netLogger.addWSRequest(page, wsUrl, data.payload);
                });
                webSocket.on("framereceived", (data) => {
                    this.#netLogger.addWSResponse(page, wsUrl, data.payload);
                });
            });
            page.on("request", async (request) => {
                return await this.#netLogger.addRequest(page, request);
            });
            page.on("response", async (response) => {
                return await this.#netLogger.addResponse(page, response);
            });
            page.on("framenavigated", (frame) => {
                // If any frame other than the top level frame is navigating,
                // we don't care about it (since requests and other behaviors
                // from the child frames will be captured by the corresponding
                // top level frame).
                if (page.mainFrame() !== frame) {
                    return;
                }
                this.#netLogger.notePageNavigation(page);
            });
        });
    }
    async addInitNavigationResponse(page, response) {
        await this.#netLogger.addAutomationPageNavigation(page, response);
    }
    // Disabling the linter here because this method is async, so that
    // other classes implementations can await/async if needed.
    //
    // eslint-disable-next-line @typescript-eslint/require-await
    async collect() {
        this.closeIfOpen();
        return {
            type: this.measurementType(),
            data: this.#netLogger.toJSON(),
        };
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibmV0d29yay5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9tZWFzdXJlbWVudHMvbmV0d29yay50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLE1BQU0sTUFBTSxvQkFBb0IsQ0FBQztBQVd4QyxPQUFPLEVBQUUsWUFBWSxFQUFxQixNQUFNLFdBQVcsQ0FBQztBQUU1RCxPQUFPLEVBQUUsZUFBZSxFQUF5QixNQUFNLGFBQWEsQ0FBQztBQWFyRSxNQUFNLGlCQUFpQjtJQUNaLE1BQU0sQ0FBdUI7SUFDN0IsU0FBUyxHQUFnQixFQUFFLENBQUM7SUFDNUIsVUFBVSxHQUFnQixFQUFFLENBQUM7SUFDN0IsUUFBUSxDQUFZO0lBQ3BCLE9BQU8sQ0FBUztJQUNoQixVQUFVLENBQVM7SUFFNUIsWUFBWSxLQUEyQixFQUFFLE1BQWMsRUFBRSxPQUFrQjtRQUN6RSxJQUFJLENBQUMsTUFBTSxHQUFHLEtBQUssQ0FBQztRQUNwQixJQUFJLENBQUMsUUFBUSxHQUFHLE9BQU8sQ0FBQztRQUN4QixJQUFJLENBQUMsT0FBTyxHQUFHLE1BQU0sQ0FBQztRQUN0QixJQUFJLENBQUMsVUFBVSxHQUFHLElBQUksQ0FBQyxHQUFHLEVBQUUsQ0FBQztJQUMvQixDQUFDO0lBRUQsTUFBTTtRQUNKLE9BQU87WUFDTCxJQUFJLEVBQUU7Z0JBQ0osU0FBUyxFQUFFLElBQUksQ0FBQyxVQUFVO2dCQUMxQixHQUFHLEVBQUUsSUFBSSxDQUFDLFFBQVE7YUFDbkI7WUFDRCxRQUFRLEVBQUUsSUFBSSxDQUFDLFNBQVM7WUFDeEIsU0FBUyxFQUFFLElBQUksQ0FBQyxVQUFVO1NBQzNCLENBQUM7SUFDSixDQUFDO0lBRUQsUUFBUTtRQUNOLE9BQU8sSUFBSSxDQUFDLE1BQU0sQ0FBQyxRQUFRLEVBQUUsQ0FBQztJQUNoQyxDQUFDO0lBRUQsZ0JBQWdCLENBQUMsR0FBVyxFQUFFLEdBQWM7UUFDMUMsSUFBSSxJQUFJLENBQUMsUUFBUSxFQUFFLEVBQUUs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LElBQUksQ0FBQyxVQUFVLENBQUMsV0FBVyxDQUFDLElBQUksRUFBRSxRQUFRLENBQUMsQ0FBQztZQUMzRCxDQUFDLENBQUMsQ0FBQztZQUVILElBQUksQ0FBQyxFQUFFLENBQUMsZ0JBQWdCLEVBQUUsQ0FBQyxLQUFZLEVBQUUsRUFBRTtnQkFDekMsNkRBQTZEO2dCQUM3RCw2REFBNkQ7Z0JBQzdELDhEQUE4RDtnQkFDOUQsb0JBQW9CO2dCQUNwQixJQUFJLElBQUksQ0FBQyxTQUFTLEVBQUUsS0FBSyxLQUFLLEVBQUUsQ0FBQztvQkFDL0IsT0FBTztnQkFDVCxDQUFDO2dCQUNELElBQUksQ0FBQyxVQUFVLENBQUMsa0JBQWtCLENBQUMsSUFBSSxDQUFDLENBQUM7WUFDM0MsQ0FBQyxDQUFDLENBQUM7UUFDTCxDQUFDLENBQUMsQ0FBQztJQUNMLENBQUM7SUFFRCxLQUFLLENBQUMseUJBQXlCLENBQUMsSUFBVSxFQUFFLFFBQWtCO1FBQzVELE1BQU0sSUFBSSxDQUFDLFVBQVUsQ0FBQywyQkFBMkIsQ0FBQyxJQUFJLEVBQUUsUUFBUSxDQUFDLENBQUM7SUFDcEUsQ0FBQztJQUVELGtFQUFrRTtJQUNsRSwyREFBMkQ7SUFDM0QsRUFBRTtJQUNGLDREQUE0RDtJQUM1RCxLQUFLLENBQUMsT0FBTztRQUNYLElBQUksQ0FBQyxXQUFXLEVBQUUsQ0FBQztRQUNuQixPQUFPO1lBQ0wsSUFBSSxFQUFFLElBQUksQ0FBQyxlQUFlLEVBQUU7WUFDNUIsSUFBSSxFQUFFLElBQUksQ0FBQyxVQUFVLENBQUMsTUFBTSxFQUFFO1NBQy9CLENBQUM7SUFDSixDQUFDO0NBQ0YiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgYXNzZXJ0IGZyb20gXCJub2RlOmFzc2VydC9zdHJpY3RcIjtcblxuaW1wb3J0IHtcbiAgQnJvd3NlckNvbnRleHQsXG4gIEZyYW1lLFxuICBQYWdlLFxuICBSZXF1ZXN0LFxuICBSZXNwb25zZSxcbiAgV2ViU29ja2V0LFxufSBmcm9tIFwiQHBsYXl3cmlnaHQvdGVzdFwiO1xuXG5pbXBvcnQgeyBCYXNlTWVhc3VyZXIsIE1lYXN1cmVtZW50UmVzdWx0IH0gZnJvbSBcIi4vYmFzZS5qc1wiO1xuaW1wb3J0IHsgTG9nZ2VyIH0gZnJvbSBcIi4uL2xvZ2dpbmcuanNcIjtcbmltcG9ydCB7IE1lYXN1cmVtZW50VHlwZSwgU2VyaWFsaXphYmxlLCBXU0ZyYW1lIH0gZnJvbSBcIi4uL3R5cGVzLmpzXCI7XG5cbnR5cGUgUmVzb3VyY2VUeXBlID0gc3RyaW5nO1xudHlwZSBUaW1lc3RhbXAgPSBudW1iZXI7XG50eXBlIFVSTFN0cmluZyA9IHN0cmluZztcblxuaW50ZXJmYWNlIERhdGFwb2ludCB7XG4gIHNpemU6IG51bWJlcjtcbiAgdGltZTogVGltZXN0YW1wO1xuICB0eXBlOiBSZXNvdXJjZVR5cGU7XG4gIHVybDogVVJMU3RyaW5nO1xufVxuXG5jbGFzcyBQYWdlTmV0d29ya0xvZ2dlciB7XG4gIHJlYWRvbmx5ICNvd25lcjogQ29udGV4dE5ldHdvcmtMb2dnZXI7XG4gIHJlYWRvbmx5ICNyZXF1ZXN0czogRGF0YXBvaW50W10gPSBbXTtcbiAgcmVhZG9ubHkgI3Jlc3BvbnNlczogRGF0YXBvaW50W10gPSBbXTtcbiAgcmVhZG9ubHkgI3BhZ2VVUkw6IFVSTFN0cmluZztcbiAgcmVhZG9ubHkgI2xvZ2dlcjogTG9nZ2VyO1xuICByZWFkb25seSAjc3RhcnRUaW1lOiBudW1iZXI7XG5cbiAgY29uc3RydWN0b3Iob3duZXI6IENvbnRleHROZXR3b3JrTG9nZ2VyLCBsb2dnZXI6IExvZ2dlciwgcGFnZVVSTDogVVJMU3RyaW5nKSB7XG4gICAgdGhpcy4jb3duZXIgPSBvd25lcjtcbiAgICB0aGlzLiNwYWdlVVJMID0gcGFnZVVSTDtcbiAgICB0aGlzLiNsb2dnZXIgPSBsb2dnZXI7XG4gICAgdGhpcy4jc3RhcnRUaW1lID0gRGF0ZS5ub3coKTtcbiAgfVxuXG4gIHRvSlNPTigpOiBTZXJpYWxpemFibGUge1xuICAgIHJldHVybiB7XG4gICAgICBtZXRhOiB7XG4gICAgICAgIHN0YXJ0VGltZTogdGhpcy4jc3RhcnRUaW1lLFxuICAgICAgICB1cmw6IHRoaXMuI3BhZ2VVUkwsXG4gICAgICB9LFxuICAgICAgcmVxdWVzdHM6IHRoaXMuI3JlcXVlc3RzLFxuICAgICAgcmVzcG9uc2VzOiB0aGlzLiNyZXNwb25zZXMsXG4gICAgfTtcbiAgfVxuXG4gIGlzQ2xvc2VkKCk6IGJvb2xlYW4ge1xuICAgIHJldHVybiB0aGlzLiNvd25lci5pc0Nsb3NlZCgpO1xuICB9XG5cbiAgbG9nRXJyb3JJZkNsb3NlZChtc2c6IHN0cmluZywgdXJsOiBVUkxTdHJpbmcpOiBib29sZWFuIHtcbiAgICBpZiAodGhpcy5pc0Nsb3NlZCgpKSB7XG4gICAgICB0aGlzLiNsb2dnZXIuZXJyb3IoXG4gICAgICAgIGB0cmllZCB0byByZWNvcmQgXCIke21zZ31cIiBidXQgbWVhc3VyZW1lbnRzIGFyZSBgICtcbiAgICAgICAgICBgY2xvc2VkLiB1cmw9JFwiJHt1cmx9XCJgLFxuICAgICAgKTtcbiAgICAgIHJldHVybiB0cnVlO1xuICAgIH1cbiAgICByZXR1cm4gZmFsc2U7XG4gIH1cblxuICBhZGRXZWJTb2NrZXRSZXF1ZXN0KHVybDogVVJMU3RyaW5nLCBkYXRhOiBXU0ZyYW1lKTogRGF0YXBvaW50IHwgbnVsbCB7XG4gICAgaWYgKHRoaXMubG9nRXJyb3JJZkNsb3NlZChcIndzIHJlcXVlc3RcIiwgdXJsKSkge1xuICAgICAgcmV0dXJuIG51bGw7XG4gICAgfVxuXG4gICAgY29uc3QgZGF0YXBvaW50ID0ge1xuICAgICAgc2l6ZTogZGF0YS5sZW5ndGgsXG4gICAgICB0aW1lOiBEYXRlLm5vdygpLFxuICAgICAgdHlwZTogXCJ3ZWJzb2NrZXRcIixcbiAgICAgIHVybDogdXJsLFxuICAgIH07XG4gICAgdGhpcy4jcmVxdWVzdHMucHVzaChkYXRhcG9pbnQpO1xuICAgIHRoaXMuI2xvZ2dlci52ZXJib3NlKFwiTmV0d29yayAoU2VudCkgOiBcIiwgZGF0YXBvaW50KTtcbiAgICByZXR1cm4gZGF0YXBvaW50O1xuICB9XG5cbiAgYWRkV2ViU29ja2V0UmVzcG9uc2UodXJsOiBVUkxTdHJpbmcsIGRhdGE6IFdTRnJhbWUpOiBEYXRhcG9pbnQgfCBudWxsIHtcbiAgICBpZiAodGhpcy5sb2dFcnJvcklmQ2xvc2VkKFwid3MgcmVzcG9uc2VcIiwgdXJsKSkge1xuICAgICAgcmV0dXJuIG51bGw7XG4gICAgfVxuXG4gICAgY29uc3QgZGF0YXBvaW50ID0ge1xuICAgICAgc2l6ZTogZGF0YS5sZW5ndGgsXG4gICAgICB0aW1lOiBEYXRlLm5vdygpLFxuICAgICAgdHlwZTogXCJ3ZWJzb2NrZXRcIixcbiAgICAgIHVybDogdXJsLFxuICAgIH07XG4gICAgdGhpcy4jcmVzcG9uc2VzLnB1c2goZGF0YXBvaW50KTtcbiAgICB0aGlzLiNsb2dnZXIudmVyYm9zZShcIk5ldHdvcmsgKFJlY2VpdmVkKSA6IFwiLCBkYXRhcG9pbnQpO1xuICAgIHJldHVybiBkYXRhcG9pbnQ7XG4gIH1cblxuICBhc3luYyBhZGRSZXF1ZXN0KHJlcXVlc3Q6IFJlcXVlc3QpOiBQcm9taXNlPERhdGFwb2ludCB8IG51bGw+IHtcbiAgICBpZiAodGhpcy5sb2dFcnJvcklmQ2xvc2VkKFwicmVxdWVzdFwiLCByZXF1ZXN0LnVybCgpKSkge1xuICAgICAgcmV0dXJuIG51bGw7XG4gICAgfVxuXG4gICAgY29uc3Qgc2l6ZXMgPSBhd2FpdCByZXF1ZXN0LnNpemVzKCk7XG4gICAgY29uc3QgZGF0YXBvaW50ID0ge1xuICAgICAgc2l6ZTogc2l6ZXMucmVxdWVzdEhlYWRlcnNTaXplICsgc2l6ZXMucmVxdWVzdEJvZHlTaXplLFxuICAgICAgdGltZTogcmVxdWVzdC50aW1pbmcoKS5yZXF1ZXN0U3RhcnQsXG4gICAgICB0eXBlOiByZXF1ZXN0LnJlc291cmNlVHlwZSgpLFxuICAgICAgdXJsOiByZXF1ZXN0LnVybCgpLFxuICAgIH07XG4gICAgdGhpcy4jcmVxdWVzdHMucHVzaChkYXRhcG9pbnQpO1xuICAgIHRoaXMuI2xvZ2dlci52ZXJib3NlKFwiTmV0d29yayAoU2VudCkgOiBcIiwgZGF0YXBvaW50KTtcbiAgICByZXR1cm4gZGF0YXBvaW50O1xuICB9XG5cbiAgYXN5bmMgYWRkUmVzcG9uc2UocmVzcG9uc2U6IFJlc3BvbnNlKTogUHJvbWlzZTxEYXRhcG9pbnQgfCBudWxsPiB7XG4gICAgaWYgKHRoaXMubG9nRXJyb3JJZkNsb3NlZChcInJlc3BvbnNlXCIsIHJlc3BvbnNlLnVybCgpKSkge1xuICAgICAgcmV0dXJuIG51bGw7XG4gICAgfVxuXG4gICAgbGV0IHJlcXVlc3QgPSByZXNwb25zZS5yZXF1ZXN0KCk7XG4gICAgY29uc3Qgc2l6ZXMgPSBhd2FpdCByZXF1ZXN0LnNpemVzKCk7XG4gICAgY29uc3QgZGF0YXBvaW50ID0ge1xuICAgICAgc2l6ZTogc2l6ZXMucmVzcG9uc2VIZWFkZXJzU2l6ZSArIHNpemVzLnJlc3BvbnNlQm9keVNpemUsXG4gICAgICB0aW1lOiByZXF1ZXN0LnRpbWluZygpLnJlc3BvbnNlRW5kLFxuICAgICAgdHlwZTogcmVxdWVzdC5yZXNvdXJjZVR5cGUoKSxcbiAgICAgIHVybDogcmVzcG9uc2UudXJsKCksXG4gICAgfTtcbiAgICB0aGlzLiNyZXNwb25zZXMucHVzaChkYXRhcG9pbnQpO1xuICAgIHRoaXMuI2xvZ2dlci52ZXJib3NlKFwiTmV0d29yayAoUmVjZWl2ZWQpIDogXCIsIGRhdGFwb2ludCk7XG5cbiAgICAvLyBBbmQgbm93IHNlZSBpZiB0aGlzIHJlc3BvbnNlIHdhcyBhIHJlc3VsdCBvZiBhIHJlZGlyZWN0aW9uIGNoYWluLFxuICAgIC8vIGluIHdoaWNoIGNhc2Ugd2UgbmVlZCB0byBhZGQgYWxsIHRoZSBpbnRlcm1lZGlhdGUgcmVxdWVzdHMgdG9vXG4gICAgLy8gKHNpbmNlIHdlJ2xsIGhhdmUgYWxyZWFkeSByZWNvcmRlZCB0aGUgaW5pdGlhbCByZXF1ZXN0KS5cbiAgICB3aGlsZSAocmVxdWVzdC5yZWRpcmVjdGVkRnJvbSgpKSB7XG4gICAgICBhd2FpdCB0aGlzLmFkZFJlcXVlc3QocmVxdWVzdCk7XG4gICAgICBjb25zdCBuZXh0UmVxdWVzdCA9IHJlcXVlc3QucmVkaXJlY3RlZEZyb20oKTtcbiAgICAgIGFzc2VydChuZXh0UmVxdWVzdCk7XG4gICAgICByZXF1ZXN0ID0gbmV4dFJlcXVlc3Q7XG4gICAgfVxuICAgIHJldHVybiBkYXRhcG9pbnQ7XG4gIH1cbn1cblxuY2xhc3MgQ29udGV4dE5ldHdvcmtMb2dnZXIge1xuICByZWFkb25seSAjcGFnZUxvZ2dlcnM6IFBhZ2VOZXR3b3JrTG9nZ2VyW10gPSBbXTtcbiAgcmVhZG9ubHkgI3BhZ2VUb0xvZ2dlck1hcDogV2Vha01hcDxQYWdlLCBQYWdlTmV0d29ya0xvZ2dlcj47XG4gIHJlYWRvbmx5ICNsb2dnZXI6IExvZ2dlcjtcbiAgcmVhZG9ubHkgI3N0YXJ0VGltZTogbnVtYmVyO1xuXG4gICNpc0Nsb3NlZCA9IGZhbHNlO1xuICAjZW5kVGltZT86IG51bWJlcjtcblxuICBjb25zdHJ1Y3Rvcihsb2dnZXI6IExvZ2dlcikge1xuICAgIHRoaXMuI3N0YXJ0VGltZSA9IERhdGUubm93KCk7XG4gICAgdGhpcy4jcGFnZVRvTG9nZ2VyTWFwID0gbmV3IFdlYWtNYXAoKTtcbiAgICB0aGlzLiNsb2dnZXIgPSBsb2dnZXI7XG4gIH1cblxuICAvLyBVc2VkIHRvIHJlY29yZCB0aGUgcmVxdWVzdCBmb3IgdGhhdHMgZHJpdmluZyBhIHBhZ2UgbmF2aWdhdGlvbiAoaS5lLixcbiAgLy8gdGhlIGluaXRpYWwgcmVxdWVzdCB0byBzdGFydCBhdXRvbWF0aW9uLCBjYXVzZWQgYnkgc29tZXRoaW5nIGxpa2VcbiAgLy8gYSBwdXBwZXRlZXIgLyBwbGF5d3JpZ2h0IHBhZ2UuZ290bygpIGNhbGwpLlxuICBhc3luYyBhZGRBdXRvbWF0aW9uUGFnZU5hdmlnYXRpb24ocGFnZTogUGFnZSwgcmVzcG9uc2U6IFJlc3BvbnNlKSB7XG4gICAgaWYgKHRoaXMuaXNDbG9zZWQoKSkge1xuICAgICAgdGhpcy4jbG9nZ2VyLmVycm9yKFxuICAgICAgICBcInRyeWluZyB0byByZWNvcmQgdG9wIGZyYW1lIG5hdmlnYXRpb24sIFwiICtcbiAgICAgICAgICBcImJ1dCBtZWFzdXJlbWVudHMgaGF2ZSBiZWVuIGNsb3NlZC4gXCIgK1xuICAgICAgICAgIGBwYWdlIHVybD1cIiR7cGFnZS51cmwoKX1cImAsXG4gICAgICApO1xuICAgICAgcmV0dXJuIG51bGw7XG4gICAgfVxuXG4gICAgY29uc3QgcGFnZU1lYXN1cmVtZW50cyA9IHRoaXMuI3BhZ2VUb0xvZ2dlck1hcC5nZXQocGFnZSk7XG4gICAgaWYgKCFwYWdlTWVhc3VyZW1lbnRzKSB7XG4gICAgICBjb25zdCBlcnJNc2cgPVxuICAgICAgICBcIlBhZ2UgbmF2aWdhdGlvbiBmb3IgYW4gdW5rbm93biBwYWdlLiBcIiArIGBwYWdlIHVybD1cIiR7cGFnZS51cmwoKX1cImA7XG4gICAgICB0aGlzLiNsb2dnZXIuZXJyb3IoZXJyTXNnKTtcbiAgICAgIHJldHVybiBudWxsO1xuICAgIH1cblxuICAgIGNvbnN0IG5hdlJlcXVlc3QgPSByZXNwb25zZS5yZXF1ZXN0KCk7XG4gICAgYXdhaXQgcGFnZU1lYXN1cmVtZW50cy5hZGRSZXF1ZXN0KG5hdlJlcXVlc3QpO1xuICAgIGF3YWl0IHBhZ2VNZWFzdXJlbWVudHMuYWRkUmVzcG9uc2UocmVzcG9uc2UpO1xuICB9XG5cbiAgYWRkV1NSZXF1ZXN0KHBhZ2U6IFBhZ2UsIHVybDogVVJMU3RyaW5nLCBkYXRhOiBXU0ZyYW1lKTogRGF0YXBvaW50IHwgbnVsbCB7XG4gICAgY29uc3QgcGFnZUZvclJlcXVlc3QgPSB0aGlzLiNwYWdlVG9Mb2dnZXJNYXAuZ2V0KHBhZ2UpO1xuICAgIGFzc2VydChwYWdlRm9yUmVxdWVzdCk7XG4gICAgcmV0dXJuIHBhZ2VGb3JSZXF1ZXN0LmFkZFdlYlNvY2tldFJlcXVlc3QodXJsLCBkYXRhKTtcbiAgfVxuXG4gIGFkZFdTUmVzcG9uc2UocGFnZTogUGFnZSwgdXJsOiBVUkxTdHJpbmcsIGRhdGE6IFdTRnJhbWUpOiBEYXRhcG9pbnQgfCBudWxsIHtcbiAgICBjb25zdCBwYWdlRm9yUmVzcG9uc2UgPSB0aGlzLiNwYWdlVG9Mb2dnZXJNYXAuZ2V0KHBhZ2UpO1xuICAgIGFzc2VydChwYWdlRm9yUmVzcG9uc2UpO1xuICAgIHJldHVybiBwYWdlRm9yUmVzcG9uc2UuYWRkV2ViU29ja2V0UmVzcG9uc2UodXJsLCBkYXRhKTtcbiAgfVxuXG4gIGFzeW5jIGFkZFJlcXVlc3QocGFnZTogUGFnZSwgcmVxdWVzdDogUmVxdWVzdCk6IFByb21pc2U8RGF0YXBvaW50IHwgbnVsbD4ge1xuICAgIGNvbnN0IHBhZ2VGb3JSZXF1ZXN0ID0gdGhpcy4jcGFnZVRvTG9nZ2VyTWFwLmdldChwYWdlKTtcbiAgICBhc3NlcnQocGFnZUZvclJlcXVlc3QpO1xuICAgIHJldHVybiBhd2FpdCBwYWdlRm9yUmVxdWVzdC5hZGRSZXF1ZXN0KHJlcXVlc3QpO1xuICB9XG5cbiAgYXN5bmMgYWRkUmVzcG9uc2UocGFnZTogUGFnZSwgcmVzcG9uc2U6IFJlc3BvbnNlKTogUHJvbWlzZTxEYXRhcG9pbnQgfCBudWxsPiB7XG4gICAgY29uc3QgcGFnZUZvclJlc3BvbnNlID0gdGhpcy4jcGFnZVRvTG9nZ2VyTWFwLmdldChwYWdlKTtcbiAgICBhc3NlcnQocGFnZUZvclJlc3BvbnNlKTtcbiAgICByZXR1cm4gYXdhaXQgcGFnZUZvclJlc3BvbnNlLmFkZFJlc3BvbnNlKHJlc3BvbnNlKTtcbiAgfVxuXG4gIC8vIE5vdGVzIHRoYXQgdGhlIHRvcCBsZXZlbCBmcmFtZSBpbiB0aGUgcGFnZSBoYXMgbmF2aWdhdGVkLCBhbmQgc29cbiAgLy8gYW55IGZ1dHVyZSByZXF1ZXN0cyB0aGF0IGhhcHBlbiBvbiB0aGUgcGFnZSBhcmUgaGFwcGVuaW5nIG9uIGEgZGlmZmVyZW50XG4gIC8vIHRvcCBsZXZlbCBkb2N1bWVudC5cbiAgbm90ZVBhZ2VOYXZpZ2F0aW9uKHBhZ2U6IFBhZ2UpOiBQYWdlTmV0d29ya0xvZ2dlciB8IG51bGwge1xuICAgIGlmICh0aGlzLmlzQ2xvc2VkKCkpIHtcbiAgICAgIHRoaXMuI2xvZ2dlci5lcnJvcihcbiAgICAgICAgXCJ0cnlpbmcgdG8gYWRkIG1lYXN1cmVtZW50cyBmb3IgbmV3IHRvcCBmcmFtZSBcIiArXG4gICAgICAgICAgXCJidXQgbWVhc3VyZW1lbnRzIGhhdmUgYmVlbiBjbG9zZWQuIFwiICtcbiAgICAgICAgICBgcGFnZSB1cmw9XCIke3BhZ2UudXJsKCl9XCJgLFxuICAgICAgKTtcbiAgICAgIHJldHVybiBudWxsO1xuICAgIH1cbiAgICBjb25zdCBwYWdlTG9nZ2VyID0gbmV3IFBhZ2VOZXR3b3JrTG9nZ2VyKHRoaXMsIHRoaXMuI2xvZ2dlciwgcGFnZS51cmwoKSk7XG4gICAgdGhpcy4jcGFnZUxvZ2dlcnMucHVzaChwYWdlTG9nZ2VyKTtcbiAgICB0aGlzLiNwYWdlVG9Mb2dnZXJNYXAuc2V0KHBhZ2UsIHBhZ2VMb2dnZXIpO1xuICAgIHJldHVybiBwYWdlTG9nZ2VyO1xuICB9XG5cbiAgaXNDbG9zZWQoKTogYm9vbGVhbiB7XG4gICAgcmV0dXJuIHRoaXMuI2lzQ2xvc2VkO1xuICB9XG5cbiAgdG9KU09OKCk6IFNlcmlhbGl6YWJsZSB7XG4gICAgY29uc3QgcGFnZVJlcG9ydHM6IFNlcmlhbGl6YWJsZVtdID0gW107XG4gICAgZm9yIChjb25zdCBhTG9nZ2VyIG9mIHRoaXMuI3BhZ2VMb2dnZXJzKSB7XG4gICAgICBwYWdlUmVwb3J0cy5wdXNoKGFMb2dnZXIudG9KU09OKCkpO1xuICAgIH1cblxuICAgIHJldHVybiB7XG4gICAgICBtZXRhOiB7XG4gICAgICAgIHN0YXJ0VGltZTogdGhpcy4jc3RhcnRUaW1lLFxuICAgICAgICBlbmRUaW1lOiB0aGlzLiNlbmRUaW1lLFxuICAgICAgfSxcbiAgICAgIHBhZ2VzOiBwYWdlUmVwb3J0cyxcbiAgICB9O1xuICB9XG5cbiAgY2xvc2UoKTogYm9vbGVhbiB7XG4gICAgaWYgKHRoaXMuaXNDbG9zZWQoKSkge1xuICAgICAgdGhpcy4jbG9nZ2VyLmVycm9yKFwidHJ5aW5nIHRvIGNsb3NlIGFscmVhZHkgY2xvc2VkIG5ldHdvcmsgbWVhc3VyZW1lbnRzXCIpO1xuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cbiAgICB0aGlzLiNlbmRUaW1lID0gRGF0ZS5ub3coKTtcbiAgICB0aGlzLiNpc0Nsb3NlZCA9IHRydWU7XG4gICAgdGhpcy4jbG9nZ2VyLnZlcmJvc2UoXCJjbG9zaW5nIG5ldHdvcmsgbWVhc3VyZW1lbnRzXCIpO1xuICAgIHJldHVybiB0cnVlO1xuICB9XG59XG5cbmV4cG9ydCBjbGFzcyBOZXR3b3JrTWVhc3VyZXIgZXh0ZW5kcyBCYXNlTWVhc3VyZXIge1xuICByZWFkb25seSAjbmV0TG9nZ2VyOiBDb250ZXh0TmV0d29ya0xvZ2dlcjtcblxuICBjb25zdHJ1Y3Rvcihsb2dnZXI6IExvZ2dlciwgdXJsOiBVUkwsIGNvbnRleHQ6IEJyb3dzZXJDb250ZXh0KSB7XG4gICAgc3VwZXIobG9nZ2VyLCB1cmwsIGNvbnRleHQpO1xuICAgIHRoaXMuI25ldExvZ2dlciA9IG5ldyBDb250ZXh0TmV0d29ya0xvZ2dlcihsb2dnZXIpO1xuICB9XG5cbiAgbWVhc3VyZW1lbnRUeXBlKCk6IE1lYXN1cmVtZW50VHlwZSB7XG4gICAgcmV0dXJuIE1lYXN1cmVtZW50VHlwZS5OZXR3b3JrO1xuICB9XG5cbiAgaW5zdHJ1bWVudCgpIHtcbiAgICBzdXBlci5pbnN0cnVtZW50KCk7XG4gICAgdGhpcy5jb250ZXh0Lm9uKFwicGFnZVwiLCAocGFnZTogUGFnZSkgPT4ge1xuICAgICAgcGFnZS5vbihcIndlYnNvY2tldFwiLCAod2ViU29ja2V0OiBXZWJTb2NrZXQpID0+IHtcbiAgICAgICAgY29uc3Qgd3NVcmwgPSB3ZWJTb2NrZXQudXJsKCk7XG4gICAgICAgIHdlYlNvY2tldC5vbihcImZyYW1lc2VudFwiLCAoZGF0YTogeyBwYXlsb2FkOiBXU0ZyYW1lIH0pID0+IHtcbiAgICAgICAgICB0aGlzLiNuZXRMb2dnZXIuYWRkV1NSZXF1ZXN0KHBhZ2UsIHdzVXJsLCBkYXRhLnBheWxvYWQpO1xuICAgICAgICB9KTtcblxuICAgICAgICB3ZWJTb2NrZXQub24oXCJmcmFtZXJlY2VpdmVkXCIsIChkYXRhOiB7IHBheWxvYWQ6IFdTRnJhbWUgfSkgPT4ge1xuICAgICAgICAgIHRoaXMuI25ldExvZ2dlci5hZGRXU1Jlc3BvbnNlKHBhZ2UsIHdzVXJsLCBkYXRhLnBheWxvYWQpO1xuICAgICAgICB9KTtcbiAgICAgIH0pO1xuXG4gICAgICBwYWdlLm9uKFwicmVxdWVzdFwiLCBhc3luYyAocmVxdWVzdDogUmVxdWVzdCkgPT4ge1xuICAgICAgICByZXR1cm4gYXdhaXQgdGhpcy4jbmV0TG9nZ2VyLmFkZFJlcXVlc3QocGFnZSwgcmVxdWVzdCk7XG4gICAgICB9KTtcblxuICAgICAgcGFnZS5vbihcInJlc3BvbnNlXCIsIGFzeW5jIChyZXNwb25zZTogUmVzcG9uc2UpID0+IHtcbiAgICAgICAgcmV0dXJuIGF3YWl0IHRoaXMuI25ldExvZ2dlci5hZGRSZXNwb25zZShwYWdlLCByZXNwb25zZSk7XG4gICAgICB9KTtcblxuICAgICAgcGFnZS5vbihcImZyYW1lbmF2aWdhdGVkXCIsIChmcmFtZTogRnJhbWUpID0+IHtcbiAgICAgICAgLy8gSWYgYW55IGZyYW1lIG90aGVyIHRoYW4gdGhlIHRvcCBsZXZlbCBmcmFtZSBpcyBuYXZpZ2F0aW5nLFxuICAgICAgICAvLyB3ZSBkb24ndCBjYXJlIGFib3V0IGl0IChzaW5jZSByZXF1ZXN0cyBhbmQgb3RoZXIgYmVoYXZpb3JzXG4gICAgICAgIC8vIGZyb20gdGhlIGNoaWxkIGZyYW1lcyB3aWxsIGJlIGNhcHR1cmVkIGJ5IHRoZSBjb3JyZXNwb25kaW5nXG4gICAgICAgIC8vIHRvcCBsZXZlbCBmcmFtZSkuXG4gICAgICAgIGlmIChwYWdlLm1haW5GcmFtZSgpICE9PSBmcmFtZSkge1xuICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLiNuZXRMb2dnZXIubm90ZVBhZ2VOYXZpZ2F0aW9uKHBhZ2UpO1xuICAgICAgfSk7XG4gICAgfSk7XG4gIH1cblxuICBhc3luYyBhZGRJbml0TmF2aWdhdGlvblJlc3BvbnNlKHBhZ2U6IFBhZ2UsIHJlc3BvbnNlOiBSZXNwb25zZSkge1xuICAgIGF3YWl0IHRoaXMuI25ldExvZ2dlci5hZGRBdXRvbWF0aW9uUGFnZU5hdmlnYXRpb24ocGFnZSwgcmVzcG9uc2UpO1xuICB9XG5cbiAgLy8gRGlzYWJsaW5nIHRoZSBsaW50ZXIgaGVyZSBiZWNhdXNlIHRoaXMgbWV0aG9kIGlzIGFzeW5jLCBzbyB0aGF0XG4gIC8vIG90aGVyIGNsYXNzZXMgaW1wbGVtZW50YXRpb25zIGNhbiBhd2FpdC9hc3luYyBpZiBuZWVkZWQuXG4gIC8vXG4gIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBAdHlwZXNjcmlwdC1lc2xpbnQvcmVxdWlyZS1hd2FpdFxuICBhc3luYyBjb2xsZWN0KCk6IFByb21pc2U8TWVhc3VyZW1lbnRSZXN1bHQgfCBudWxsPiB7XG4gICAgdGhpcy5jbG9zZUlmT3BlbigpO1xuICAgIHJldHVybiB7XG4gICAgICB0eXBlOiB0aGlzLm1lYXN1cmVtZW50VHlwZSgpLFxuICAgICAgZGF0YTogdGhpcy4jbmV0TG9nZ2VyLnRvSlNPTigpLFxuICAgIH07XG4gIH1cbn1cbiJdfQ==